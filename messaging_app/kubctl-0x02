#!/bin/bash

# kubctl-0x02 - Blue-Green Deployment Script
# This script deploys both blue and green versions and manages traffic switching

echo "ðŸ”„ Starting Blue-Green Deployment Process..."

# Function to check pod health
check_pod_health() {
    local version=$1
    echo "ðŸ¥ Checking health of $version pods..."
    
    # Wait for pods to be ready
    kubectl wait --for=condition=Ready pod -l version=$version --timeout=300s
    
    # Check logs for errors
    echo "ðŸ“‹ Checking logs for $version version..."
    kubectl logs -l version=$version --tail=50 | grep -i error || echo "âœ… No errors found in $version logs"
    
    return 0
}

# Function to switch traffic
switch_traffic() {
    local target_version=$1
    echo "ðŸ”€ Switching traffic to $target_version version..."
    
    # Update the active service selector
    kubectl patch service django-messaging-service-active -p '{"spec":{"selector":{"version":"'$target_version'"}}}'
    
    echo "âœ… Traffic switched to $target_version version"
}

# Deploy Blue version
echo "ðŸ”µ Deploying Blue version..."
kubectl apply -f blue_deployment.yaml

# Deploy Green version
echo "ðŸŸ¢ Deploying Green version..."
kubectl apply -f green_deployment.yaml

# Apply services
echo "ðŸ”— Setting up services..."
kubectl apply -f kubeservice.yaml

# Wait for deployments to be ready
echo "â³ Waiting for Blue deployment to be ready..."
kubectl rollout status deployment/django-messaging-app-blue --timeout=300s

echo "â³ Waiting for Green deployment to be ready..."
kubectl rollout status deployment/django-messaging-app-green --timeout=300s

# Check health of both versions
check_pod_health "blue"
check_pod_health "green"

# Show current pod status
echo "ðŸ“¦ Current pod status:"
kubectl get pods -l app=django-messaging-app -o wide

# Show deployment status
echo "ðŸ“Š Deployment status:"
kubectl get deployments -l app=django-messaging-app

# Show service status
echo "ðŸ”— Service status:"
kubectl get services -l app=django-messaging-app

# Test both versions if possible
echo "ðŸ§ª Testing both versions..."

# Port forward to test blue version
echo "ðŸ”µ Testing Blue version..."
kubectl port-forward service/django-messaging-service-blue 8081:80 &
BLUE_PID=$!
sleep 3

if curl -s http://localhost:8081/health/ > /dev/null; then
    echo "âœ… Blue version is responding"
else
    echo "âŒ Blue version is not responding"
fi

kill $BLUE_PID 2>/dev/null || true

# Port forward to test green version
echo "ðŸŸ¢ Testing Green version..."
kubectl port-forward service/django-messaging-service-green 8082:80 &
GREEN_PID=$!
sleep 3

if curl -s http://localhost:8082/health/ > /dev/null; then
    echo "âœ… Green version is responding"
else
    echo "âŒ Green version is not responding"
fi

kill $GREEN_PID 2>/dev/null || true

# Interactive traffic switching
echo "ðŸ”€ Current active version: $(kubectl get service django-messaging-service-active -o jsonpath='{.spec.selector.version}')"

read -p "Do you want to switch traffic to Green version? (y/n): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    switch_traffic "green"
    
    # Verify the switch
    echo "ðŸ” Verifying traffic switch..."
    kubectl port-forward service/django-messaging-service-active 8083:80 &
    ACTIVE_PID=$!
    sleep 3
    
    if curl -s http://localhost:8083/health/ > /dev/null; then
        echo "âœ… Active service is responding after switch"
    else
        echo "âŒ Active service is not responding after switch"
    fi
    
    kill $ACTIVE_PID 2>/dev/null || true
fi

# Final status check
echo "ðŸ“‹ Final deployment status:"
kubectl get all -l app=django-messaging-app

echo "âœ… Blue-Green deployment process complete!"
echo "ðŸ’¡ Use 'kubectl get pods -l app=django-messaging-app' to monitor your deployments"
echo "ðŸ’¡ Use the switch_traffic function in this script to change between versions"